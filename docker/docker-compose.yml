services:
  # 1. Database
  mongo:
    image: mongo:7
    container_name: kyriqlab-mongo
    restart: unless-stopped
    command: ["mongod", "--auth"]
    environment:
      MONGO_INITDB_DATABASE: kyriqlab
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - kyriqlab_mongo_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - backend_net  # Internal DB network (secure)

# 2. Backend API
  kyriqlab-api:
    build: ../backend
    container_name: kyriqlab-api
    dns:
      - 8.8.8.8
      - 1.1.1.1
    restart: unless-stopped
    env_file:
      - ../backend/.env
    volumes:
      - kyriqlab_uploads:/app/uploads
    networks:
      - backend_net  # To talk to Mongo
      - proxy_net    # To talk to Nginx (and potentially Tunnel)
    depends_on:
      - mongo

  # 3. Nginx (Frontend + Proxy)
  nginx:
    image: nginx:alpine
    container_name: kyriqlab-nginx
    restart: unless-stopped
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ../frontend/dist:/usr/share/nginx/html:ro
    # No ports needed! The Tunnel talks to this container directly.
    # ports:
    #   - "80:80" 
    depends_on:
      - kyriqlab-api
    networks:
      - proxy_net

# REMOVED: tunnel service (Moving to central infrastructure)

volumes:
  kyriqlab_mongo_data:
    external: true
    name: docker_kyriqlab_mongo_data
  kyriqlab_uploads:
    external: true
    name: kyriqlab_uploads

networks:
  proxy_net:
    external: true  # Use the network we created in Step 1
  backend_net:      # Keep DB traffic private
